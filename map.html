<!-- 
TODO :

- Lorsqu'on ajoute un nouveau marqueur en cliquant, sur le popup il n'y à pas le boutton supprimer de matthias
- Lorsqu'on ajout un nouveau marqueur en cliquant, il faut l'ajouter au 'L.markerClusterGroup' (todo diego) (fixed)
- Lorsqu'on ajout un nouveau marqueur en cliquant et qu'on dessine tout les points avec la side bar, tout les points ajouté par l'user sont en double.
- zoom in / out il se réaffiche
-->


<!DOCTYPE html>

<html>

<head>

	<title>Carte</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<!-- carte background -->
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
		integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
		crossorigin=""></script>

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
		integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />

	<!-- leaflet main -->
	<link rel="stylesheet" href="screen.css" />
	<link rel="stylesheet" href="node_modules/leaflet.markercluster/dist/MarkerCluster.css" />
	<link rel="stylesheet" href="node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css" />

	<!-- leaflet extension cluster -->
	<script src="node_modules/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>


	<!-- Boostrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="leaflet-sidebar.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Jquery UI -->
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

	<style>
		body {
			padding: 0;
			margin: 0;
		}

		html,
		body {
			height: 100%;
			margin: 0;
		}

		html,
		body,
		#map {
			height: 100%;
			font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
		}

		.lorem {
			font-style: italic;
			color: #AAA;
		}

		.sidenav {
			height: 100%;
			width: 0;
			position: fixed;
			z-index: 1;
			top: 0;
			left: 0;
			background-color: #111;
			overflow-x: hidden;
			transition: 0.5s;
			padding-top: 60px;
		}

		.sidenav a {
			padding: 8px 8px 8px 32px;
			text-decoration: none;
			font-size: 25px;
			color: #818181;
			display: block;
			transition: 0.3s;
		}

		.sidenav a:hover {
			color: #f1f1f1;
		}

		.sidenav .closebtn {
			position: absolute;
			top: 0;
			right: 25px;
			font-size: 36px;
			margin-left: 50px;
		}

		@media screen and (max-height: 450px) {
			.sidenav {
				padding-top: 15px;
			}

			.sidenav a {
				font-size: 18px;
			}
		}

		#map {
			position: absolute;
			width: 100%;
			height: 100%;
			z-index: 1;
		}

		.ui-autocomplete {
			position: relative;
		}

		#divFloat {
			display: none;
			position: absolute;
			background-color: white;
			margin-left: 80%;
			margin-top: 2%;
			padding: 10px;
			width: 15%;
			z-index: 2;
		}
	</style>

</head>

<body>

	<script src="leaflet-sidebar.js"></script>
	<div id="sidebar" class="sidebar collapsed">
		<div class="sidebar-tabs">
			<ul role="tablist">
				<li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
				<li><a href="#formSelect" role="tab"><i class="fab fa-wpforms"></i></a></li>
				<li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
				<li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
			</ul>

			<ul role="tablist">
				<li><a href="#aboutus" role="tab"><i class="fas fa-users"></i></a></li>
			</ul>
		</div>

		<div class="sidebar-content">
			<div class="sidebar-pane" id="home">
				<h1 class="sidebar-header">
					Menu Site Web
					<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
				</h1>
				<h2><a href="" role="button"><i class="fas fa-globe-europe"></i> La carte</a></h2>
				<h2><a href="stats" role="button"><i class="far fa-chart-bar"></i> Les stats</a></h2>

			</div>

			<div class="sidebar-pane " id="formSelect">
				<h1 class="sidebar-header">Formulaire de selection<span class="sidebar-close"><i
							class="fa fa-caret-left"></i></span></h1>
				<div class="container ui-front" style="width:100%;">
					<h3>Sélectionner les attributs du ou des tournages souhaités</h3>
					<form id="formLoaderFilter" autocomplete="off">
						<div class="form-group">
							<label for="formLoaderFilter__type_de_tournage">Type de tournage</label>
							<select class="form-control" id="formLoaderFilter__type_de_tournage">
								<option>NON RENSEIGNE</option>
								<option>TELEFILM</option>
								<option>LONG METRAGE</option>
								<option>SERIE TELEVISEE</option>
							</select>
						</div>
						<div class="form-group" id="titre">
							<label for="formLoaderFilter__titre">Titre</label>
							<input class="form-control" type="search" onkeyup='this.value=this.value.toUpperCase()'
								id="formLoaderFilter__titre">

						</div>
						<div class="form-group" id="real">
							<label for="formLoaderFilter__realisateur">Realisateur</label>
							<input class="form-control" type="search" onkeyup='this.value=this.value.toUpperCase()'
								id="formLoaderFilter__realisateur">
						</div>
						<div class="form-group " id="orga">
							<label for="formLoaderFilter__organisme_demandeur">Organisme demandeur</label>
							<input class="form-control" type="search" onkeyup='this.value=this.value.toUpperCase()'
								id="formLoaderFilter__organisme_demandeur">

						</div>
						<div class="form-group">
							<label for="formLoaderFilter__adresse">Adresse</label>
							<input class="form-control" type="search" onkeyup='this.value=this.value.toUpperCase()'
								id="formLoaderFilter__adresse">
						</div>
						<div class="form-group">
							<label for="formLoaderFilter__ardt">Arrondissement</label>
							<input class="form-control" type="search" id="formLoaderFilter__ardt">
						</div>
						<div class="form-group">
							<label for="formLoaderFilter__date_debut">Date de debut de tournage</label>
							<input class="form-control" type="date" min="2016-01-01" max="2016-12-01"
								id="formLoaderFilter__date_debut">
						</div>
						<div class="form-group">
							<label for="formLoaderFilter__date_fin">Date de fin de tournage</label>
							<input class="form-control" type="date" min="2016-01-01" max="2016-12-01"
								id="formLoaderFilter__date_fin">
						</div>
						<button class="btn btn-primary" type="submit" id="sub">Valider</button>
					</form>
				</div>
			</div>
			<div class="sidebar-pane" id="profile">
				<h1 class="sidebar-header">Profile<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
				</h1>
				<p> COUCOU TOI </p>
			</div>

			<div class="sidebar-pane" id="messages">
				<h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
				</h1>
			</div>

			<div class="sidebar-pane" id="aboutus">
				<h1 class="sidebar-header">Notre groupe<span class="sidebar-close"><i
							class="fa fa-caret-left"></i></span></h1>
				<h2> <i class="fas fa-user-astronaut"></i> Pierre CRY </h2>
				<h2> <i class="fas fa-user-secret"></i> Diego ORTIZ </h2>
				<h2> <i class="fas fa-user-ninja"></i> Matthias AMBROISE </h2>
			</div>
		</div>
	</div>

	<div id="map" class="sidebar-map"></div>

	<div id="divFloat" class="sidebar-form">
		<form id="formAff">
			<div style="display:block;">
				<input id="formAff__id"></input>
			</div>
			<div class="form-group">
				<label for="formAff__type_de_tournage">Type de tournage</label>
				<select class="form-control" id="formAff__type_de_tournage">
					<option>NON RENSEIGNE</option>
					<option>TELEFILM</option>
					<option>LONG METRAGE</option>
					<option>SERIE TELEVISEE</option>
				</select>
			</div>
			<div class="form-group">
				<label for="formAff__titre">Titre</label>
				<input class="form-control" type="text" onkeyup='this.value=this.value.toUpperCase()'
					id="formAff__titre">
			</div>
			<div class="form-group">
				<label for="formAff__realisateur">Realisateur</label>
				<input class="form-control" type="text" onkeyup='this.value=this.value.toUpperCase()'
					id="formAff__realisateur">
			</div>
			<div class="form-group">
				<label for="formAff__organisme_demandeur">Organisme demandeur</label>
				<input class="form-control" type="text" onkeyup='this.value=this.value.toUpperCase()'
					id="formAff__organisme_demandeur">
			</div>
			<div class="form-group">
				<label for="formAff__adresse">Adresse</label>
				<input class="form-control" type="text" onkeyup='this.value=this.value.toUpperCase()'
					id="formAff__adresse">
			</div>
			<div class="form-group">
				<label for="formAff__ardt">Arrondissement</label>
				<input class="form-control" type="text" id="formAff__ardt">
			</div>
			<div class="form-group">
				<label for="formAff__date_debut">Date de debut de tournage</label>
				<input class="form-control" type="date" min="2016-01-01" max="2016-12-01" id="formAff__date_debut">
			</div>
			<div class="form-group">
				<label for="formAff__date_fin">Date de fin de tournage</label>
				<input class="form-control" type="date" min="2016-01-01" max="2016-12-01" id="formAff__date_fin">
			</div>
		</form>
		<button class="btn btn-primary" onclick="modifMarker(document.getElementById('formAff__id').value)">Modifier</button>

		<button class="btn btn-primary">Supprimer</button>
		<button class="btn btn-primary"
			onclick="document.getElementById('divFloat').style.display = 'none'">Fermer</button>
	</div>

	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	<script>

		var map;
		var flag = true;
		var newMarker;
		var newMarkerId;
		

		var sidebar = L.control.sidebar('sidebar').addTo(map);
		map = L.map('map').setView([48.866667, 2.333333], 12);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
				'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);


		var points;
		var mapMarkers = [];

		$(document).ready(
			function () {
				alltitreRecup();
				allrealRecup();
				allorgaRecup();
			}
		);


		function onPopupOpen() {

			var tempMarker = this;

			// To remove marker on click of delete
			$(".marker-delete-button:visible").click(function () {
				var lID = tempMarker._leaflet_id; // Getting Leaflet ID of this marker

				// Faire un appel ajax pour supprimer côté client

				map.removeLayer(tempMarker);
				$("#divFloat").css("display", "none");
			});
		}
		//////////////////////////////////////////////////////////////////////
		
		function modifMarker(id) {
			
			console.log(id,newMarkerId,id == newMarkerId);
			if (id == newMarkerId) {
				flag = true;
				console.log("lol",newMarker);
				console.log(map.removeLayer(newMarker));
				map.removeLayer(newMarker)
				console.log("done");
				document.getElementById('sub').click();
			}
		}
		
		$('#formLoaderFilter').submit(function (evt) {

			evt.preventDefault();

			$.ajax({
				method: 'GET',
				url: 'http://localhost:444/geojson',
				dataType: 'json',
				success: function (response) {
					var markers = L.markerClusterGroup();
					points = L.geoJSON(response, {
						onEachFeature: function (feature, layer) {
							layer.bindPopup(
								'<div>'
								+ '<label>Longitude: ' + feature.properties.xy[0] + '</label>'
								+ '</br>'
								+ '<label>Latitude: ' + feature.properties.xy[1] + '</label>'
								+ '</div>'
								+ "<input type='button' value='Supprimer ce marqueur' class='marker-delete-button btn btn-primary'/>"
							);

							layer.on("popupopen", onPopupOpen);

							layer.on('click', function (evt) {
								document.getElementById('divFloat').style.display = 'block';
								document.getElementById('formAff__id').value = feature.properties.id;
								document.getElementById('formAff__type_de_tournage').value = feature.properties.type_de_tournage;
								document.getElementById('formAff__titre').value = feature.properties.titre;
								document.getElementById('formAff__realisateur').value = feature.properties.realisateur;
								document.getElementById('formAff__organisme_demandeur').value = feature.properties.organisme_demandeur;
								document.getElementById('formAff__adresse').value = feature.properties.adresse;
								document.getElementById('formAff__ardt').value = feature.properties.ardt;
								document.getElementById('formAff__date_debut').value = feature.properties.date_debut;
								document.getElementById('formAff__date_fin').value = feature.properties.date_fin;
							});
						}, filter: function (feature, layer) {
							var val_tdt = document.getElementById('formLoaderFilter__type_de_tournage').value;
							if (val_tdt == 'NON RENSEIGNE') { var bool_tdp = true; } else { bool_tdp = (feature.properties.type_de_tournage == val_tdt); }
							var val_t = document.getElementById('formLoaderFilter__titre').value;
							if (val_t == '') { var bool_t = true; } else { bool_t = (feature.properties.titre == val_t); }
							var val_r = document.getElementById('formLoaderFilter__realisateur').value;
							if (val_r == '') { var bool_r = true; } else { bool_r = (feature.properties.realisateur == val_r); }
							var val_od = document.getElementById('formLoaderFilter__organisme_demandeur').value;
							if (val_od == '') { var bool_od = true; } else { bool_od = (feature.properties.organisme_demandeur == val_od); }
							var val_ad = document.getElementById('formLoaderFilter__adresse').value;
							if (val_ad == '') { var bool_ad = true; } else { bool_ad = (feature.properties.adresse == val_ad); }
							var val_ar = document.getElementById('formLoaderFilter__ardt').value;
							if (val_ar == '') { var bool_ar = true; } else { bool_ar = (feature.properties.ardt == val_ar); }
							var val_dd = document.getElementById('formLoaderFilter__date_debut').value;
							if (val_dd == '') { var bool_dd = true; } else { bool_dd = (feature.properties.date_debut == val_dd); }
							var val_df = document.getElementById('formLoaderFilter__date_fin').value;
							if (val_df == '') { var bool_df = true; } else { bool_df = (feature.properties.date_fin == val_df); }
							return (bool_tdp && bool_t && bool_r && bool_od && bool_ad && bool_ar && bool_dd && bool_df);
						}
					});


					mapMarkers.push(markers);
					for (var i = 0; i < mapMarkers.length; i++) {
						map.removeLayer(mapMarkers[i]);
					}
					markers.addLayer(points);
					map.addLayer(markers);
				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		});

		//Creation d'un point dans la map et dans la db
		
		function addMarker(lat, lng, newid) {
			$.ajax({
				method: 'POST',
				url: 'http://localhost:444/userInput',
				data: { id: newid, x: lat, y: lng },
				success: function (response) {
					// addMarker(e); // ?
				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		}
		map.on('click', function (e) {
			if (!flag) {return;}
			$.ajax({
				method: 'GET',
				url: 'http://localhost:444/nombredeligne',
				dataType: 'json',
				success: function (response) {
					var lat = e.latlng.lat;
					var lng = e.latlng.lng;
					var newid = response.nb;
					newMarkerId = newid;
					newMarker = L.marker(e.latlng);
					newMarker.bindPopup(
						'<div>'
						+ '<label>Longitude: ' + e.latlng.lng + '</label>'
						+ '</br>'
						+ '<label>Latitude: ' + e.latlng.lat + '</label>'
						+ '</div>'
						+ "<input type='button' value='Supprimer ce marqueur' class='marker-delete-button btn btn-primary'/>"
					);
					newMarker.on('click', function (evt) {
						document.getElementById('divFloat').style.display = 'block';
						document.getElementById('formAff__id').value = response.nb;
						document.getElementById('formAff__type_de_tournage').value = "";
						document.getElementById('formAff__titre').value = "";
						document.getElementById('formAff__realisateur').value = "";
						document.getElementById('formAff__organisme_demandeur').value = "";
						document.getElementById('formAff__adresse').value = "";
						document.getElementById('formAff__ardt').value = "";
						document.getElementById('formAff__date_debut').value = "";
						document.getElementById('formAff__date_fin').value = "";
					});
					console.log(newMarker);
					map.addLayer(newMarker);
					addMarker(lat, lng, newid);
					flag = false;	//Pour créer un nouveau markers, il faut cliquer sur modif
					newMarkerId = newid;
				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		});

		
		function alltitreRecup() {
			var data = [];
			$.ajax({
				method: 'GET',
				url: 'http://localhost:444/alltitre',
				dataType: 'json',
				success: function (response) {
					data = response.info;
					$("#formLoaderFilter__titre").autocomplete({
						source: response.info,
						appendTo: "#titre"
					});


				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		}

		function allrealRecup() {
			var data = []
			$.ajax({
				method: 'GET',
				url: 'http://localhost:444/allreal',
				dataType: 'json',
				success: function (response) {
					$("#formLoaderFilter__realisateur").autocomplete({
						source: response.info,
						appendTo: "#real"
					});
				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		}

		function allorgaRecup() {
			var data = [];
			$.ajax({
				method: 'GET',
				url: 'http://localhost:444/allorga',
				dataType: 'json',
				success: function (response) {
					data = response.info;
					$("#formLoaderFilter__organisme_demandeur").autocomplete({
						source: response.info,
						appendTo: "#orga"
					});
				},
				error: function (jqXHR, text, error) {
					console.log(jqXHR, text, error);
				}
			});
		}


	</script>
</body>

</html>